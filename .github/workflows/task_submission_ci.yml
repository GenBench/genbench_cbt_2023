# Adapted from https://github.com/huggingface/evaluate/blob/main/.github/workflows/ci.yml
name: CI

on:
  pull_request:
    types:
      - labeled
    branches:
      - main

jobs:
  check_code_quality:
    if: github.event.label.name == 'task-submission'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .[quality]
      - name: Check quality
        run: |
          make check-quality

  test_genbench_impl:
    needs: check_code_quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
      - name: Upgrade pip
        run: python -m pip install --upgrade pip
      - name: Install dependencies
        run: |
          pip install .[tests]
      - name: Test with pytest
        run: |
          python -m pytest -n 2 -sv ./tests/ --ignore=./tests/test_task.py

  test_task:
    needs: test_genbench_impl
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
      - name: Upgrade pip
        run: python -m pip install --upgrade pip
      - name: Install dependencies
        run: |
          pip install .[tests]
        

      - name: Detect New Task ID
        id: task_id
        # Get the most recent modified task directory and extract the task ID
        run: |
            task_id=$(ls -td src/genbench/tasks/*/ | head -n 1 | cut -d'/' -f4)
            echo "Task ID: $task_id"
            echo "::set-output name=task_id::$task_id"

      - name: Test Task
        run: |
          genbench-cli test-task -i ${{ steps.task_id.outputs.task_id }}
